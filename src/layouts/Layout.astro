---
import '../styles/global.css';
import { translations } from '../lib/i18n';
import GlobalAudioProcessor from '../components/react/GlobalAudioProcessor';
import ProcessNotification from '../components/react/ProcessNotification';
import { ClientRouter } from 'astro:transitions';
import Analytics from '@vercel/analytics/astro';
import SpeedInsights from "@vercel/speed-insights/astro";

export interface Props {
  title: string;
  description?: string;
  lang?: string;
}

const {
  title,
  description = 'Transform recorded lectures into structured study notes with AI.',
  lang = 'es',
} = Astro.props;
---

<!DOCTYPE html>
<html lang={lang}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' blob: https://va.vercel-scripts.com https://unpkg.com; connect-src 'self' blob: https://api.groq.com https://generativelanguage.googleapis.com https://unpkg.com https://va.vercel-scripts.com https://vitals.vercel-insights.com; img-src 'self' blob: data: https:; media-src 'self' blob: data:; worker-src 'self' blob:; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://api.fontshare.com; font-src 'self' https://fonts.gstatic.com https://fonts.fontshare.com https://cdn.fontshare.com;" />
    <meta name="description" content={description} />
    <meta name="theme-color" content="#09090b" />
    <meta name="generator" content={Astro.generator} />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="canonical" href={new URL(Astro.url.pathname, Astro.site)} />
    <meta name="google-site-verification" content="53AHVf3g0uTFJzGjxUgBoXeN7-bbDwyruX4z_VssiyA" />

    <title>{title}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Outfit:wght@400;700&display=swap" rel="stylesheet" crossorigin="anonymous">
    <link href="https://api.fontshare.com/v2/css?f[]=satoshi@700,900&display=swap" rel="stylesheet" crossorigin="anonymous">
    <ClientRouter />

    <script is:inline define:vars={{ translations }}>
      function getTheme() {
        if (typeof localStorage !== 'undefined' && localStorage.getItem('scn-theme')) {
          return localStorage.getItem('scn-theme');
        }
        return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      }

      function applyTheme(theme) {
        if (theme === 'dark') {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
        localStorage.setItem('scn-theme', theme);
      }

      function getLang() {
        const stored = localStorage.getItem('scn-lang');
        if (stored === 'en' || stored === 'es') return stored;
        return navigator.language.startsWith('en') ? 'en' : 'es';
      }

      function applyLang(lang) {
        document.documentElement.lang = lang;
        document.querySelectorAll('[data-i18n]').forEach(el => {
          const key = el.getAttribute('data-i18n');
          if (translations[key] && translations[key][lang]) {
            el.innerHTML = translations[key][lang];
          }
        });
        const navToggle = document.getElementById('lang-toggle-nav');
        if (navToggle) navToggle.textContent = lang.toUpperCase();
      }

      // Initialize Immediately
      applyTheme(getTheme());
      
      // We must wait for DOM to apply language to components with data-i18n
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => applyLang(getLang()));
      } else {
        applyLang(getLang());
      }

      // Re-apply after Astro View Transition navigation
      document.addEventListener('astro:after-swap', () => {
        applyTheme(getTheme());
        applyLang(getLang());
      });

      // Global Toggles
      window.toggleTheme = () => {
        const next = getTheme() === 'dark' ? 'light' : 'dark';
        applyTheme(next);
        window.dispatchEvent(new CustomEvent('scn-theme-change', { detail: next }));
      };

      window.toggleLang = () => {
        const next = getLang() === 'es' ? 'en' : 'es';
        setLocale(next);
        applyLang(next);
        window.dispatchEvent(new CustomEvent('scn-lang-change', { detail: next }));
      };

      // Helper for external scripts
      window.setLocale = (lang) => {
        localStorage.setItem('scn-lang', lang);
      };

      // Listener for buttons
      document.addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (btn) {
          if (btn.id === 'theme-toggle') window.toggleTheme();
          if (btn.id === 'lang-toggle-nav') window.toggleLang();
          if (btn.id === 'config-toggle') window.dispatchEvent(new CustomEvent('scn-open-config'));
        }
      });
    </script>
  </head>
  <body class="custom-scrollbar">
    <div transition:persist="global-processor">
        <GlobalAudioProcessor client:only="react" />
        <ProcessNotification client:only="react" />
    </div>
    <slot />
    <Analytics />
    <SpeedInsights />
  </body>
</html>
